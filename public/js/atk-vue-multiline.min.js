"use strict";(self.webpackChunkatk=self.webpackChunkatk||[]).push([[71],{77590:(e,t,n)=>{n.r(t),n.d(t,{default:()=>d});n(92963),n(96454),n(67242),n(90170),n(42359),n(99789),n(30034),n(59668),n(62052);var i=n(21145),o=n.n(i),l=n(86157);var a=n(30901),s=n(49880);const r={name:"AtkMultilineCell",template:'\n        <component\n            :is="getComponent()"\n            v-bind="getComponentProps()"\n            ref="cell"\n            :fluid="true"\n            class="fluid"\n            :name="inputName"\n            v-model="inputValue"\n            @update:modelValue="onInput"\n        ></component>',components:{AtkMultilineReadonly:{name:"AtkMultilineReadonly",template:"<div>{{readOnlyValue}}</div>",props:["readOnlyValue"]},AtkMultilineTextarea:{name:"AtkMultilineTextarea",template:'<textarea v-model="modelValue" @input="onInput" />',props:["modelValue"],emits:["update:modelValue"],methods:{onInput:function(e){this.$emit("update:modelValue",e.target.value)}}},AtkDatePicker:a.Z,AtkLookup:s.Z},props:["cellData","fieldValue"],data:function(){return{fieldName:this.cellData.name,type:this.cellData.type,inputName:"-"+this.cellData.name,inputValue:this.fieldValue}},emits:["updateValue"],methods:{getComponent:function(){return this.cellData.definition.component},getComponentProps:function(){return"AtkMultilineReadonly"===this.getComponent()?{readOnlyValue:this.fieldValue}:this.cellData.definition.componentProps},onInput:function(e){this.inputValue=e,this.$emit("updateValue",this.fieldName,this.inputValue)}}},u={name:"AtkMultilineHeader",template:'\n        <SuiTableHeader>\n            <SuiTableRow v-if="hasError()">\n                <SuiTableCell :style="{ background: \'none\' }" />\n                <SuiTableCell :style="{ background: \'none\' }"\n                    error="true"\n                    v-for="column in filterVisibleColumns(columns)"\n                    :textAlign="getTextAlign(column)"\n                >\n                    <SuiIcon v-if="getErrorMsg(column)" name="attention" />\n                    {{getErrorMsg(column)}}\n                </SuiTableCell>\n            </SuiTableRow>\n            <SuiTableRow v-if="hasCaption()">\n                <SuiTableHeaderCell :colspan="getVisibleColumns()">{{caption}}</SuiTableHeaderCell>\n            </SuiTableRow>\n            <SuiTableRow :verticalAlign="\'top\'">\n                <SuiTableHeaderCell :width=1 textAlign="center">\n                    <input ref="check" type="checkbox" :checked="isChecked" :indeterminate="isIndeterminate" @input="onToggleDeleteAll" />\n                </SuiTableHeaderCell>\n                <SuiTableHeaderCell\n                    v-for="column in filterVisibleColumns(columns)"\n                    :width=column.cellProps.width\n                    :textAlign="getTextAlign(column)"\n                >\n                    <div>{{column.caption}}</div>\n                    <div v-if="false" :style="{ position: \'absolute\', top: \'-22px\' }">\n                        <SuiLabel v-if="getErrorMsg(column)" pointing="below" basic color="red">{{getErrorMsg(column)}}</SuiLabel>\n                    </div>\n                </SuiTableHeaderCell>\n            </SuiTableRow>\n        </SuiTableHeader>',props:["fields","selectionState","errors","caption"],data:function(){return{columns:this.fields,isDeleteAll:!1}},methods:{filterVisibleColumns:function(e){return e.filter((e=>e.isVisible))},onToggleDeleteAll:function(){this.$nextTick((()=>{l.Z.eventBus.emit(this.$root.$el.parentElement.id+"-toggle-delete-all",{isOn:this.$refs.check.checked})}))},getTextAlign:function(e){let t="left";if(!e.isEditable)switch(e.type){case"integer":case"float":case"atk4_money":t="right"}return t},getVisibleColumns:function(){let e=1;for(const t of this.columns)e=t.isVisible?e+1:e;return e},hasError:function(){return Object.keys(this.errors).length>0},hasCaption:function(){return this.caption},getErrorMsg:function(e){if(this.hasError()){const t=Object.keys(this.errors);for(const n of t){const t=this.errors[n].filter((t=>t.name===e.name));if(t.length>0)return t[0].msg}}return null}},computed:{isIndeterminate:function(){return"indeterminate"===this.selectionState},isChecked:function(){return"on"===this.selectionState}}},d={name:"AtkMultiline",template:'\n        <div>\n            <SuiTable v-bind="tableProp">\n                <AtkMultilineHeader\n                    :fields="fieldData"\n                    :selectionState="getMainToggleState"\n                    :errors="errors"\n                    :caption="caption"\n                ></AtkMultilineHeader>\n                <AtkMultilineBody\n                    :fieldDefs="fieldData"\n                    :rowData="rowData"\n                    :deletables="getDeletables"\n                    :errors="errors"\n                    @onTabLastRow="onTabLastRow"\n                ></AtkMultilineBody>\n                <SuiTableFooter>\n                    <SuiTableRow>\n                        <SuiTableHeaderCell />\n                        <SuiTableHeaderCell :colspan="getSpan" textAlign="right">\n                            <SuiButtonGroup>\n                                <SuiButton ref="addButton" size="small" type="button" icon :disabled="isLimitReached" @click.stop.prevent="onAdd">\n                                    <SuiIcon name="plus" />\n                                </SuiButton>\n                                <SuiButton size="small" type="button" icon :disabled="isDeleteDisable" @click.stop.prevent="onDelete">\n                                    <SuiIcon name="trash" />\n                                </SuiButton>\n                            </SuiButtonGroup>\n                        </SuiTableHeaderCell>\n                    </SuiTableRow>\n                </SuiTableFooter>\n            </SuiTable>\n            <div>\n                <input ref="atkmlInput" :form="form" :name="name" type="hidden" :value="valueJson" />\n            </div>\n        </div>',props:{data:Object},data:function(){return{form:this.data.formName,valueJson:this.data.inputValue,name:this.data.inputName,rowData:[],fieldData:this.data.fields||[],eventFields:this.data.eventFields||[],deletables:[],hasChangeCb:this.data.hasChangeCb,errors:{},caption:this.data.caption||null,tableProp:{basic:!1,celled:!1,collapsing:!1,stackable:!1,inverted:!1,...this.data.tableProps}}},components:{AtkMultilineHeader:u,AtkMultilineBody:{name:"AtkMultilineBody",template:'\n        <SuiTableBody>\n            <AtkMultilineRow\n                :fields="fields"\n                v-for="(row, i) in rows" :key="row.__atkml"\n                :rowId="row.__atkml"\n                :isDeletable="isDeletableRow(row)"\n                :rowValues="row"\n                :errors="getRowErrors(row.__atkml)"\n                @onTabLastColumn="onTabLastColumn(i)"\n            ></AtkMultilineRow>\n        </SuiTableBody>',props:["fieldDefs","rowData","deletables","errors"],data:function(){return{fields:this.fieldDefs}},created:function(){},components:{AtkMultilineRow:{name:"AtkMultilineRow",template:'\n        <SuiTableRow :verticalAlign="\'middle\'">\n            <SuiTableCell textAlign="center">\n                <input type="checkbox" v-model="toDelete" @input="onToggleDelete" />\n            </SuiTableCell>\n            <SuiTableCell\n                v-for="(column, i) in filterVisibleColumns(columns)"\n                v-bind="column.cellProps"\n                :width=null\n                :error="hasColumnError(column)"\n                :style="{ overflow: \'visible\' }"\n                @keydown.tab="onTab(i)"\n            >\n                <AtkMultilineCell\n                    :cellData="column"\n                    :fieldValue="getValue(column)"\n                    @updateValue="onUpdateValue"\n                ></AtkMultilineCell>\n            </SuiTableCell>\n        </SuiTableRow>',props:["fields","rowId","isDeletable","rowValues","errors"],data:function(){return{columns:this.fields}},components:{AtkMultilineCell:r},computed:{toDelete:{get:function(){return this.isDeletable},set:function(e){return e}}},emits:["onTabLastColumn"],methods:{filterVisibleColumns:function(e){return e.filter((e=>e.isVisible))},onTab:function(e){e===this.columns.filter((e=>e.isEditable)).length&&this.$emit("onTabLastColumn")},hasColumnError:function(e){return this.errors.some((t=>e.name===t.name))},getColumnWidth:function(e){return e.fieldOptions?e.fieldOptions.width:null},onEdit:function(){this.isEditing=!0},onToggleDelete:function(e){l.Z.eventBus.emit(this.$root.$el.parentElement.id+"-toggle-delete",{rowId:this.rowId})},onUpdateValue:function(e,t){l.Z.eventBus.emit(this.$root.$el.parentElement.id+"-update-row",{rowId:this.rowId,fieldName:e,value:t})},getValue:function(e){return this.rowValues[e.name]||e.default}}}},computed:{rows:function(){return this.rowData}},emits:["onTabLastRow"],methods:{onTabLastColumn:function(e){e+1===this.rowData.length&&this.$emit("onTabLastRow")},isDeletableRow:function(e){return this.deletables.includes(e.__atkml)},getRowErrors:function(e){return this.errors[e]??[]}}}},mounted:function(){this.rowData=this.buildRowData(this.valueJson??"[]"),this.updateInputValue(),l.Z.eventBus.on(this.$root.$el.parentElement.id+"-update-row",(e=>{this.onUpdate(e.rowId,e.fieldName,e.value)})),l.Z.eventBus.on(this.$root.$el.parentElement.id+"-toggle-delete",(e=>{const t=this.deletables.indexOf(e.rowId);-1!==t?this.deletables.splice(t,1):this.deletables.push(e.rowId)})),l.Z.eventBus.on(this.$root.$el.parentElement.id+"-toggle-delete-all",(e=>{if(this.deletables=[],e.isOn)for(const e of this.rowData)this.deletables.push(e.__atkml)})),l.Z.eventBus.on(this.$root.$el.parentElement.id+"-multiline-rows-error",(e=>{this.errors={...e.errors}}))},methods:{onTabLastRow:function(){!this.isLimitReached&&this.data.addOnTab&&this.onAdd()},onAdd:function(){const e=this.createRow(this.data.fields);this.rowData.push(e),this.updateInputValue(),this.data.afterAdd&&"function"==typeof this.data.afterAdd&&this.data.afterAdd(JSON.parse(this.valueJson)),this.fetchExpression(e.__atkml),this.fetchOnUpdateAction()},onDelete:function(){for(const e of this.deletables)this.deleteRow(e);this.deletables=[],this.updateInputValue(),this.fetchOnUpdateAction(),this.data.afterDelete&&"function"==typeof this.data.afterDelete&&this.data.afterDelete(JSON.parse(this.valueJson))},onUpdate:function(e,t,n){this.updateFieldInRow(e,t,n),this.clearError(e,t),this.updateInputValue(),this.onUpdate.debouncedFx||(this.onUpdate.debouncedFx=l.Z.createDebouncedFx((()=>{this.onUpdate.debouncedFx=null,this.fetchExpression(e),this.fetchOnUpdateAction(t)}),250)),this.onUpdate.debouncedFx.call(this)},createRow:function(e){const t={};for(const n of e)t[n.name]=n.default;return t.__atkml=this.getUUID(),t},deleteRow:function(e){this.rowData.splice(this.rowData.findIndex((t=>t.__atkml===e)),1),delete this.errors[e]},updateFieldInRow:function(e,t,n){for(const i of this.rowData)i.__atkml===e&&(i[t]=n)},clearError:function(e,t){if(e in this.errors){const n=this.errors[e].filter((e=>e.name!==t));this.errors[e]=[...n],0===n.length&&delete this.errors[e]}},updateInputValue:function(){this.valueJson=JSON.stringify(this.rowData)},buildRowData:function(e){const t=JSON.parse(e);for(const e of t)e.__atkml=this.getUUID();return t},hasExpression:function(){return this.fieldData.some((e=>e.isExpr))},fetchOnUpdateAction:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.hasChangeCb&&(null===e||this.eventFields.includes(e))&&o()(this.$refs.addButton.$el).api({on:"now",url:this.data.url,method:"POST",data:{__atkml_action:"on-change",rows:this.valueJson}})},postData:async function(e){const t={...e},n=this.$refs.addButton.$el;t.__atkml_action="update-row";try{return await l.Z.apiService.suiFetch(this.data.url,{data:t,method:"POST",stateContext:n})}catch(e){console.error(e)}},fetchExpression:async function(e){if(this.hasExpression()){const t=this.findRow(e);if(t){const n=await this.postData(t);if(n.expressions){const t=Object.keys(n.expressions);for(const i of t)this.updateFieldInRow(e,i,n.expressions[i]);this.updateInputValue()}}}},findRow:function(e){return this.rowData.find((t=>t.__atkml===e))},getInputElement:function(){return this.$refs.atkmlInput},getUUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replaceAll(/[xy]/g,(e=>{const t=Math.floor(16*Math.random());return("x"===e?t:11&t).toString(16)}))}},computed:{getSpan:function(){return this.fieldData.length-1},getDeletables:function(){return this.deletables},getMainToggleState:function(){let e="off";return this.deletables.length>0&&(e=this.deletables.length===this.rowData.length?"on":"indeterminate"),e},isDeleteDisable:function(){return 0===this.deletables.length},isLimitReached:function(){return 0!==this.data.rowLimit&&this.data.rowLimit<this.rowData.length+1}}}},30901:(e,t,n)=>{n.d(t,{Z:()=>i});const i={name:"AtkDatePicker",template:'\n        <FlatpickrPicker\n            :config="flatPickr"\n            :modelValue="getFlatpickrValue(modelValue)"\n            @update:modelValue="onUpdate"\n        />',props:["config","modelValue"],data:function(){const e={...this.config};return e.defaultDate&&!this.modelValue?e.defaultDate=new Date:this.modelValue&&(e.defaultDate=this.modelValue),e.locale||(e.locale=flatpickr.l10ns.default),{flatPickr:e}},emits:["setDefault"],mounted:function(){!this.modelValue&&this.flatPickr.defaultDate&&this.onUpdate(this.flatPickr.defaultDate instanceof Date?flatpickr.formatDate(this.config.defaultDate,this.config.dateFormat):this.flatPickr.defaultDate)},methods:{getFlatpickrValue:function(e){return e},onUpdate:function(e){this.$emit("update:modelValue",e)}}}},49880:(e,t,n)=>{n.d(t,{Z:()=>i});n(59668),n(90170),n(62052);const i={name:"AtkLookup",template:'\n        <SuiDropdown\n            v-bind="dropdownProps"\n            ref="drop"\n            :modelValue="getDropdownValue(modelValue)"\n            @update:modelValue="onUpdate"\n        ></SuiDropdown>',props:["config","modelValue","optionalValue"],data:function(){const{url:e,reference:t,...n}=this.config;return n.selection=!0,{dropdownProps:n,url:e||null,field:t,query:"",temp:""}},mounted:function(){this.optionalValue&&(this.dropdownProps.options=Array.isArray(this.optionalValue)?this.optionalValue:[this.optionalValue])},emits:["update:modelValue"],methods:{getDropdownValue:function(e){return this.dropdownProps.options.find((t=>t.value===e))},onUpdate:function(e){this.$emit("update:modelValue",e.value)}}}},99789:(e,t,n)=>{var i=n(19882),o=n(57416).some;i({target:"AsyncIterator",proto:!0,real:!0},{some:function(e){return o(this,e)}})},30034:(e,t,n)=>{var i=n(19882),o=n(5166),l=n(97676),a=n(83875),s=n(82716);i({target:"Iterator",proto:!0,real:!0},{some:function(e){a(this),l(e);var t=s(this),n=0;return o(t,(function(t,i){if(e(t,n++))return i()}),{IS_RECORD:!0,INTERRUPTED:!0}).stopped}})}}]);
//# sourceMappingURL=atk-vue-multiline.min.js.map