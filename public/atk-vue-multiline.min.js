(self.webpackChunkatk=self.webpackChunkatk||[]).push([[71],{4527:(t,e,n)=>{"use strict";n.r(e),n.d(e,{default:()=>v});n(7327),n(9826),n(4553),n(9554),n(2772),n(561),n(8309),n(7941),n(1539),n(4916),n(9714),n(5306),n(4747);var i=n(7757),a=n.n(i),r=(n(5666),n(8926)),o=n.n(r),l=n(319),s=n.n(l),u=n(9713),c=n.n(u);n(9653);const d={name:"atk-textarea",template:'<textarea v-model="text" @input="handleChange"></textarea>',props:{value:[String,Number]},data:function(){return{text:this.value}},methods:{handleChange:function(t){this.$emit("input",t.target.value)}}};var h=n(7537),f=n(2549);const p={name:"atk-multiline-cell",template:' \n    <component :is="getComponent()"\n        :fluid="true"  \n        class="fluid" \n        @input="onInput"\n        @onChange="onChange"\n        v-model="inputValue"\n        :name="inputName"\n        ref="cell"\n        v-bind="getComponentProps()"></component>\n  ',components:{"atk-multiline-readonly":{template:"<div>{{readOnlyValue}}</div>",name:"atk-multiline-readonly",props:["readOnlyValue"]},"atk-multiline-textarea":d,"atk-date-picker":h.Z,"atk-lookup":f.Z},props:["cellData","fieldValue"],data:function(){return{fieldName:this.cellData.name,type:this.cellData.type,inputName:"-"+this.cellData.name,inputValue:this.fieldValue}},methods:{getComponent:function(){return this.cellData.definition.component},getComponentProps:function(){return"atk-multiline-readonly"===this.getComponent()?{readOnlyValue:this.fieldValue}:this.cellData.definition.componentProps},onInput:function(t){this.inputValue=this.getTypeValue(t),this.$emit("update-value",this.fieldName,this.inputValue)},onChange:function(t){this.onInput(t)},getTypeValue:function(t){var e=t;return"boolean"===this.type&&(e=t.target.checked),e}}},m={name:"atk-multiline-header",template:'\n     <sui-table-header>\n       <sui-table-row v-if="hasError()">\n        <sui-table-cell :style="{background:\'none\'}"></sui-table-cell>\n        <sui-table-cell :style="{background:\'none\'}" state="error" v-for="(column, idx) in columns" :key="idx" v-if="column.isVisible" :textAlign="getTextAlign(column)"><sui-icon name="attention" v-if="getErrorMsg(column)"></sui-icon>{{getErrorMsg(column)}}</sui-table-cell>\n      </sui-table-row>\n       <sui-table-row v-if="hasCaption()">\n        <sui-table-headerCell :colspan="getVisibleColumns()">{{caption}}</sui-table-headerCell>\n       </sui-table-row>\n        <sui-table-row :verticalAlign="\'top\'">\n        <sui-table-header-cell width="one" textAlign="center"><input type="checkbox" @input="onToggleDeleteAll" :checked.prop="isChecked" :indeterminate.prop="isIndeterminate" ref="check"></input></sui-table-header-cell>\n        <sui-table-header-cell v-for="(column, idx) in columns" :key="idx" v-if="column.isVisible" :textAlign="getTextAlign(column)">\n         <div>{{column.caption}}</div>\n         <div :style="{position: \'absolute\', top: \'-22px\'}" v-if="false"><sui-label pointing="below" basic color="red" v-if="getErrorMsg(column)">{{getErrorMsg(column)}}</sui-label></div>\n        </sui-table-header-cell>\n      </sui-table-row>\n    </sui-table-header>\n  ',props:["fields","state","errors","caption"],data:function(){return{columns:this.fields,isDeleteAll:!1}},methods:{onToggleDeleteAll:function(){var t=this;this.$nextTick((function(){atk.eventBus.emit(t.$root.$el.id+"-toggle-delete-all",{isOn:t.$refs.check.checked})}))},getTextAlign:function(t){var e="left";if(!t.isEditable)switch(t.type){case"money":case"integer":case"number":e="right"}return e},getVisibleColumns:function(){var t=1;return this.columns.forEach((function(e){t=e.isVisible?t+1:t})),t},hasError:function(){return Object.keys(this.errors).length>0},hasCaption:function(){return this.caption},getErrorMsg:function(t){if(this.hasError())for(var e=Object.keys(this.errors),n=0;n<e.length;n++){var i=this.errors[e[n]].filter((function(e){return e.name===t.name}));if(i.length>0)return i[0].msg}return null}},computed:{isIndeterminate:function(){return"indeterminate"===this.state},isChecked:function(){return"on"===this.state}}};function b(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,i)}return n}function g(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?b(Object(n),!0).forEach((function(e){c()(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):b(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}const v={name:"atk-multiline",template:'<div>\n                <sui-table v-bind="tableProp">\n                  <atk-multiline-header :fields="fieldData" :state="getMainToggleState" :errors="errors" :caption="caption"></atk-multiline-header>\n                  <atk-multiline-body @onTabLastRow="onTabLastRow" :fieldDefs="fieldData" :rowData="rowData" :deletables="getDeletables" :errors="errors"></atk-multiline-body>\n                  <sui-table-footer>\n                    <sui-table-row>\n                        <sui-table-header-cell/>\n                        <sui-table-header-cell :colspan="getSpan" textAlign="right">\n                        <div is="sui-button-group">\n                         <sui-button size="small" @click.stop.prevent="onAdd" type="button" icon="plus" ref="addBtn" :disabled="isLimitReached"></sui-button>\n                         <sui-button size="small" @click.stop.prevent="onDelete" type="button" icon="trash" :disabled="isDeleteDisable"></sui-button>                        \n                         </div>\n                        </sui-table-header-cell>\n                    </sui-table-row>\n                  </sui-table-footer>\n                </sui-table>\n                <div><input :form="form" :name="name" type="hidden" :value="value" ref="atkmlInput"></div>\n             </div>',props:{data:Object},data:function(){return{form:this.data.formName,value:this.data.inputValue,name:this.data.inputName,rowData:[],fieldData:this.data.fields||[],eventFields:this.data.eventFields||[],deletables:[],hasChangeCb:this.data.hasChangeCb,errors:{},caption:this.data.caption||null,tableProp:g(g({},{basic:!1,celled:!1,collapsing:!1,stackable:!1,inverted:!1}),this.data.tableProps||{})}},components:{"atk-multiline-body":{name:"atk-multiline-body",template:'\n    <sui-table-body>\n      <atk-multiline-row v-for="(row , idx) in rows" :key="row.__atkml" \n      @onTabLastColumn="onTabLastColumn(idx)"\n      :fields="fields" \n      :rowId="row.__atkml" \n      :isDeletable="isDeletableRow(row)" \n      :rowValues="row"\n      :error="getError(row.__atkml)"></atk-multiline-row>\n    </sui-table-body>\n  ',props:["fieldDefs","rowData","deletables","errors"],data:function(){return{fields:this.fieldDefs}},created:function(){},components:{"atk-multiline-row":{name:"atk-multiline-row",template:'\n    <sui-table-row :verticalAlign="\'middle\'">\n        <sui-table-cell width="one" textAlign="center"><input type="checkbox" @input="onToggleDelete" v-model="toDelete"></input></sui-table-cell>\n        <sui-table-cell  @keydown.tab="onTab(idx)" v-for="(column, idx) in columns" :key="idx" :state="getErrorState(column)" v-bind="column.cellProps" :style="{overflow: \'visible\'}" v-if="column.isVisible">\n         <atk-multiline-cell\n           :cellData="column" \n           @update-value="onUpdateValue"\n           :fieldValue="getValue(column)"></atk-multiline-cell>\n        </sui-table-cell>\n    </sui-table-row>\n  ',props:["fields","rowId","isDeletable","rowValues","error"],data:function(){return{columns:this.fields}},components:{"atk-multiline-cell":p},computed:{toDelete:{get:function(){return this.isDeletable},set:function(t){return t}}},methods:{onTab:function(t){t===this.columns.filter((function(t){return t.isEditable})).length&&this.$emit("onTabLastColumn")},getErrorState:function(t){if(this.error&&this.error.filter((function(e){return t.name===e.name})).length>0)return"error";return null},getColumnWidth:function(t){return t.fieldOptions?t.fieldOptions.width:null},onEdit:function(){this.isEditing=!0},onToggleDelete:function(t){atk.eventBus.emit(this.$root.$el.id+"-toggle-delete",{rowId:this.rowId})},onUpdateValue:function(t,e){atk.eventBus.emit(this.$root.$el.id+"-update-row",{rowId:this.rowId,fieldName:t,value:e})},getValue:function(t){return this.rowValues[t.name]||t.default}}}},computed:{rows:function(){return this.rowData}},methods:{onTabLastColumn:function(t){t+1===this.rowData.length&&this.$emit("onTabLastRow")},isDeletableRow:function(t){return this.deletables.indexOf(t.__atkml)>-1},getError:function(t){return t in this.errors?this.errors[t]:null}}},"atk-multiline-header":m},mounted:function(){var t=this;this.rowData=this.buildRowData(this.value),this.updateInputValue(),atk.eventBus.on(this.$root.$el.id+"-update-row",(function(e){t.onUpdate(e.rowId,e.fieldName,e.value)})),atk.eventBus.on(this.$root.$el.id+"-toggle-delete",(function(e){var n=t.deletables.indexOf(e.rowId);n>-1?t.deletables.splice(n,1):t.deletables.push(e.rowId)})),atk.eventBus.on(this.$root.$el.id+"-toggle-delete-all",(function(e){t.deletables=[],e.isOn&&t.rowData.forEach((function(e){t.deletables.push(e.__atkml)}))})),atk.eventBus.on(this.$root.$el.id+"-multiline-rows-error",(function(e){t.errors=g({},e.errors)}))},methods:{onTabLastRow:function(){!this.isLimitReached&&this.data.addOnTab&&this.onAdd()},onAdd:function(){var t=this.createRow(this.data.fields);this.rowData.push(t),this.updateInputValue(),this.data.afterAdd&&"function"==typeof this.data.afterAdd&&this.data.afterAdd(atk.utils.json().tryParse(this.value)),this.fetchExpression(t.__atkml),this.fetchOnChangeAction()},onDelete:function(){var t=this;this.deletables.forEach((function(e){t.deleteRow(e)})),this.deletables=[],this.updateInputValue(),this.fetchOnChangeAction(),this.data.afterDelete&&"function"==typeof this.data.afterDelete&&this.data.afterDelete(atk.utils.json().tryParse(this.value))},onUpdate:function(t,e,n){var i=this;this.updateFieldInRow(t,e,n),this.clearError(t,e),this.updateInputValue(),atk.debounce((function(){i.fetchExpression(t),i.fetchOnChangeAction(e)}),300).call(this)},createRow:function(t){var e={};return t.forEach((function(t){e[t.name]=t.default})),e.__atkml=this.getUUID(),e},deleteRow:function(t){this.rowData.splice(this.rowData.findIndex((function(e){return e.__atkml===t})),1),delete this.errors[t]},updateFieldInRow:function(t,e,n){this.rowData.forEach((function(i){i.__atkml===t&&(i[e]=n)}))},clearError:function(t,e){if(t in this.errors){var n=this.errors[t].filter((function(t){return t.name!==e}));this.errors[t]=s()(n),0===n.length&&delete this.errors[t]}},updateInputValue:function(){this.value=JSON.stringify(this.rowData)},buildRowData:function(t){var e=this,n=atk.utils.json().tryParse(t,[]);return n.forEach((function(t){t.__atkml=e.getUUID()})),n},hasExpression:function(){return this.fieldData.filter((function(t){return t.isExpr})).length>0},fetchOnChangeAction:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.hasChangeCb&&(null===t||this.eventFields.indexOf(t)>-1)&&jQuery(this.$refs.addBtn.$el).api({on:"now",url:this.data.url,method:"post",data:{__atkml_action:"on-change",rows:this.value}})},postData:(w=o()(a().mark((function t(e){var n,i;return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=g({},e),i=this.$refs.addBtn.$el,n.__atkml_action="update-row",t.prev=3,t.next=6,atk.apiService.suiFetch(this.data.url,{data:n,method:"post",stateContext:i});case 6:return t.abrupt("return",t.sent);case 9:t.prev=9,t.t0=t.catch(3),console.error(t.t0);case 12:case"end":return t.stop()}}),t,this,[[3,9]])}))),function(t){return w.apply(this,arguments)}),fetchExpression:(k=o()(a().mark((function t(e){var n,i,r=this;return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!this.hasExpression()){t.next=7;break}if(!(n=this.findRow(e))){t.next=7;break}return t.next=5,this.postData(n);case 5:(i=t.sent).expressions&&(Object.keys(i.expressions).forEach((function(t){r.updateFieldInRow(e,t,i.expressions[t])})),this.updateInputValue());case 7:case"end":return t.stop()}}),t,this)}))),function(t){return k.apply(this,arguments)}),findRow:function(t){return this.rowData.find((function(e){return e.__atkml===t}))},getInputElement:function(){return this.$refs.atkmlInput},getUUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return("x"===t?e:11&e).toString(16)}))}},computed:{getSpan:function(){return this.fieldData.length-1},getDeletables:function(){return this.deletables},getMainToggleState:function(){var t="off";return this.deletables.length>0&&(t=this.deletables.length===this.rowData.length?"on":"indeterminate"),t},isDeleteDisable:function(){return!this.deletables.length>0},isLimitReached:function(){return 0!==this.data.rowLimit&&this.data.rowLimit<this.rowData.length+1}}};var k,w},7537:(t,e,n)=>{"use strict";n.d(e,{Z:()=>r});var i=n(6479),a=n.n(i);const r={name:"atk-date-picker",template:'<flat-picker v-model="date" :config="flatPickr" @on-change="onChange"></flat-picker>',props:["config","value"],data:function(){var t=this.config,e=t.useDefault,n=a()(t,["useDefault"]);return!e||n.defaultDate||this.value?this.value&&(n.defaultDate=this.value):n.defaultDate=new Date,n.locale||(n.locale=flatpickr.l10ns.default),{flatPickr:n,date:null}},mounted:function(){!this.value&&this.flatPickr.defaultDate&&(this.flatPickr.defaultDate instanceof Date?this.$emit("setDefault",flatpickr.formatDate(this.config.defaultDate,this.config.dateFormat)):this.$emit("setDefault",this.flatPickr.defaultDate))},methods:{onChange:function(t){this.$emit("onChange",flatpickr.formatDate(t[0],this.flatPickr.dateFormat))}}}},2549:(t,e,n)=>{"use strict";n.d(e,{Z:()=>u});var i=n(7757),a=n.n(i),r=(n(5666),n(8926)),o=n.n(r),l=n(6479),s=n.n(l);const u={name:"atk-lookup",template:'<sui-dropdown \n                    ref="drop"\n                    v-bind="dropdownProps" \n                    :loading="isLoading" \n                    @input="onChange" \n                    @filtered="onFiltered" \n                    v-model="current" \n                    :class="css"></sui-dropdown>',props:["config","value","optionalValue"],data:function(){var t=this.config,e=t.url,n=t.reference,i=t.ui,a=s()(t,["url","reference","ui"]);return a.selection=!0,{dropdownProps:a,current:this.value,url:e||null,css:[i],isLoading:!1,field:n,query:"",temp:""}},mounted:function(){this.optionalValue&&(this.dropdownProps.options=Array.isArray(this.optionalValue)?this.optionalValue:[this.optionalValue])},methods:{onChange:function(t){this.$emit("onChange",t)},onFiltered:function(t){var e=this;t&&(this.isLoading=!0),this.temp=t,atk.debounce((function(){e.query!==e.temp&&(e.query=e.temp,e.query&&e.fetchItems(e.query))}),300).call(this)},fetchItems:(c=o()(a().mark((function t(e){var n,i;return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,n={atk_vlookup_q:e,atk_vlookup_field:this.field},t.next=4,atk.apiService.suiFetch(this.url,{method:"get",data:n});case 4:(i=t.sent).success&&(this.dropdownProps.options=i.results),this.isLoading=!1,t.next=13;break;case 9:t.prev=9,t.t0=t.catch(0),console.error(t.t0),this.isLoading=!1;case 13:case"end":return t.stop()}}),t,this,[[0,9]])}))),function(t){return c.apply(this,arguments)})}};var c}}]);